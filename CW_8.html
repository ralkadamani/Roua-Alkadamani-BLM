<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" href="https://openweathermap.org/img/w/04d.png" />
    <title>Open Weather</title>
    <style>
      body {
        max-width: 450px;
        margin: 0;
      }
      div {
        display: inline-block;
        margin: 12px;
        vertical-align: top;
      }
      p {
        margin: 0;
      }
      b {
        font-size: 18px;
      }
      pre {
        overflow-x: auto;
        font-size: 14px;
      }
      .dar {width: 42%;}
      #main {
        box-sizing: border-box;
        width: 100%;
        padding: 20px;
        text-align: center;
        background: #9cf;
        font-size: 24px;
        margin: 0;
      }
      #yer {
        margin: 10px;
      }
      #err {
        color: red;
      }
      #kod { margin-left: 8px; }
    </style>
  </head>

  <body
  class="vsc-initialized" data-new-gr-c-s-check-loaded="14.1089.0"
    data-gr-ext-installed="">
    <div>
      <p>Latitude:</p>
      <input id="latitude" value="42" />
      <p>Longitude:</p>
      <input id="longitude" value="29" />
      <p></p>
      <button onclick="askWeather()">Ask Weather</button>
    </div>

    <div id="main">
        <p id="yer">Maltepe, TR</p>
        <p><img id="icon" src="https://openweathermap.org/img/w/01d.png">
        <span id="hava">Clear  14°</span></p>
    </div> 

 

    <div id="one">
      <h2 id="title"></h2>
      <input id="but" type="button" value="Run" onclick="start()" /> &emsp; Zoom
      = <span id="out">10</span>
    </div>
    <hr />
    <div
      id="map"
      style="width: 400px; height: 400px; position: relative; outline: none"
      class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom"
      tabindex="0"
    >
      <div
        class="leaflet-pane leaflet-map-pane"
        style="transform: translate3d(0px, 0px, 0px)"
      >
        <div class="leaflet-pane leaflet-tile-pane">
          <div class="leaflet-layer" style="z-index: 1; opacity: 1">
            <div
              class="leaflet-tile-container leaflet-zoom-animated"
              style="
                z-index: 18;
                transform: translate3d(-179px, -77px, 0px) scale(1);
              "
            >
              <img
                alt=""
                role="presentation"
                src="https://c.tile.openstreetmap.org/10/594/383.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(210px, 24px, 0px);
                  opacity: 1;
                "
              /><img
                alt=""
                role="presentation"
                src="https://a.tile.openstreetmap.org/10/595/383.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(466px, 24px, 0px);
                  opacity: 1;
                "
              /><img
                alt=""
                role="presentation"
                src="https://a.tile.openstreetmap.org/10/594/384.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(210px, 280px, 0px);
                  opacity: 1;
                "
              /><img
                alt=""
                role="presentation"
                src="https://b.tile.openstreetmap.org/10/595/384.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(466px, 280px, 0px);
                  opacity: 1;
                "
              /><img
                alt=""
                role="presentation"
                src="https://b.tile.openstreetmap.org/10/593/383.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(-46px, 24px, 0px);
                  opacity: 1;
                "
              /><img
                alt=""
                role="presentation"
                src="https://c.tile.openstreetmap.org/10/593/384.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(-46px, 280px, 0px);
                  opacity: 1;
                "
              />
            </div>
            <div
              class="leaflet-tile-container leaflet-zoom-animated"
              style="
                z-index: 17;
                transform: translate3d(0px, 15px, 0px) scale(0.5);
              "
            ></div>
          </div>
          <div class="leaflet-layer" style="z-index: 1; opacity: 1">
            <div
              class="leaflet-tile-container leaflet-zoom-animated"
              style="
                z-index: 17;
                transform: translate3d(90px, 61px, 0px) scale(0.5);
              "
            ></div>
            <div
              class="leaflet-tile-container leaflet-zoom-animated"
              style="
                z-index: 18;
                transform: translate3d(0px, 0px, 0px) scale(1);
              "
            >
              <img
                alt=""
                role="presentation"
                src="https://c.tile.openstreetmap.org/10/594/383.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(31px, -53px, 0px);
                  opacity: 1;
                "
              /><img
                alt=""
                role="presentation"
                src="https://a.tile.openstreetmap.org/10/594/384.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(31px, 203px, 0px);
                  opacity: 1;
                "
              /><img
                alt=""
                role="presentation"
                src="https://b.tile.openstreetmap.org/10/593/383.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(-225px, -53px, 0px);
                  opacity: 1;
                "
              /><img
                alt=""
                role="presentation"
                src="https://a.tile.openstreetmap.org/10/595/383.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(287px, -53px, 0px);
                  opacity: 1;
                "
              /><img
                alt=""
                role="presentation"
                src="https://c.tile.openstreetmap.org/10/593/384.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(-225px, 203px, 0px);
                  opacity: 1;
                "
              /><img
                alt=""
                role="presentation"
                src="https://b.tile.openstreetmap.org/10/595/384.png"
                class="leaflet-tile leaflet-tile-loaded"
                style="
                  width: 256px;
                  height: 256px;
                  transform: translate3d(287px, 203px, 0px);
                  opacity: 1;
                "
              />
            </div>
          </div>
        </div>
        <div class="leaflet-pane leaflet-shadow-pane"></div>
        <div class="leaflet-pane leaflet-overlay-pane"></div>
        <div class="leaflet-pane leaflet-marker-pane"></div>
        <div class="leaflet-pane leaflet-tooltip-pane"></div>
        <div class="leaflet-pane leaflet-popup-pane"></div>
        <div
          class="leaflet-proxy leaflet-zoom-animated"
          style="transform: translate3d(152233px, 98301.2px, 0px) scale(512)"
        ></div>
      </div>
      <div class="leaflet-control-container">
        <div class="leaflet-top leaflet-left">
          <div class="leaflet-control-zoom leaflet-bar leaflet-control">
            <a
              class="leaflet-control-zoom-in"
              href="#"
              title="Zoom in"
              role="button"
              aria-label="Zoom in"
              >+</a
            ><a
              class="leaflet-control-zoom-out"
              href="#"
              title="Zoom out"
              role="button"
              aria-label="Zoom out"
              >−</a
            >
          </div>
        </div>
        <div class="leaflet-top leaflet-right"></div>
        <div class="leaflet-bottom leaflet-left"></div>
        <div class="leaflet-bottom leaflet-right">
          <div class="leaflet-control-attribution leaflet-control">
            <a
              href="https://leafletjs.com"
              title="A JS library for interactive maps"
              >Leaflet</a
            >
            | © OpenStreetMap contributors
          </div>
        </div>
      </div>
    </div>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
      "use strict";
      var MAP; //global
      function init() {
        //initial coordinates are given: 50. Yil Parki
        let p = { lat: 40.970021, lng: 29.057876 };
        console.log("init at", p);
        //L is global object from leaflet
        MAP = L.map("map").setView(p, 10); //setZoom(10)
        let u = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
        let attribution = "&copy; OpenStreetMap contributors";
        L.tileLayer(u, { attribution }).addTo(MAP);
        let report = () => (out.innerText = MAP.getZoom());
        MAP.on("zoom", report);
        report();
        MAP.on("click", (e) => {
          document.getElementById("latitude").value = e.latlng.lat;
          document.getElementById("longitude").value = e.latlng.lng;
          askWeather();
        });
      }
      function toHM(t, round) {
        let d = t ? new Date(t * 1000) : new Date();
        if (round && d.getSeconds() > 29) d = new Date((t + 30) * 1000); 
        let h = d.getHours();
        let m = d.getMinutes();
        let twoDigits = (t) => (t > 9 ? "" : "0") + t;
        return twoDigits(h) + ":" + twoDigits(m);
      }
      async function toJSON(url) {
        let r = await fetch(url);
        if (!r.ok) error(r.statusText);
        return r.json();
      }
      // Location
      var lat, long;
      async function askLocation() {
      
      }
      
      // Weather
      var accessKey;
      async function askWeather() {
        let lat = document.getElementById("latitude").value;
        let lon = document.getElementById("longitude").value;
        console.log(lat, lon);
        const U = "https://api.openweathermap.org/data/2.5/weather?";
        let url = U + "lat=" + lat + "&lon=" + lon + "&APPID=" + accessKey;
        hava.innerText = "getting weather";
        detay.innerText = "";
        gunes.innerText = "";

        let data = await toJSON(url);
        changeLocation(lat, lon);
        showWeather(data);
      }
      function showWeather(data) {
        let w = data.weather[0];
        showIcon(w.icon);
        let celsius = convert(data.main.temp).toFixed(0);
        let hh = w.main + "  " + celsius + "°",
          { sys } = data;
        let yy = data.name + ", " + sys.country;
        hava.innerText = hh;
        yer.innerText = yy;
        console.log(hh, yy);
        console.log(sys);
        let lat = data.coord.lat;
        let lon = data.coord.lon;
        let loc = "[" + lat.toFixed(2) + ", " + lon.toFixed(2) + "]";
        detay.innerText =
          hh +
          "\n" +
          yy +
          "\n" +
          loc +
          "\nLAT  " +
          lat +
          "" +
          "\nLONG  " +
          lon +
          "" +
          "\nWind  " +
          (data.wind.speed * 3.6).toFixed(2) +
          " kpha" +
          "\nWind Direction  " +
          data.wind.deg +
          " °degree" +
          "\nPressure " +
          data.main.pressure +
          " hpa" +
          "\nHumidity " +
          data.main.humidity +
          "%";
        let { sunrise, sunset } = sys,
          noon = (sunrise + sunset) / 2;
        gunes.innerText =
          "Rise " +
          toHM(sunrise, 1) +
          "\nNoon " +
          toHM(noon, 1) +
          "\nSet  " +
          toHM(sunset, 1);
      }
      function showIcon(i) {
        const URL = "https://openweathermap.org/img/w/";
        icon.src = URL + i + ".png";
        document.querySelector("link").href = icon.src;
      }
      function convert(kelvin) {
        return celsius*1.8 + 32
      }
      // Interaction
      function askUser() {
        let k = prompt("Please enter openweather key:");
        if (!k) error("You need an API key");
        return k;
      }
      function error(e) {
        main.style.display = "none"; //hide
        refs.style.display = "none";
        err.style.display = ""; //show
        throw e;
      }
      function getAPIkey() {
        if (origin.startsWith("http") && localStorage) {
          if (!localStorage.keys) localStorage.keys = "{}";
          let keys = JSON.parse(localStorage.keys);
          if (!keys.openweather) {
            keys.openweather = askUser();
            localStorage.keys = JSON.stringify(keys);
          }
          accessKey = keys.openweather;
        } else {
          //cannot use localStorage
          accessKey = askUser();
        }
      }
      function changeLocation(latitude, longitude) {
        let p = { lat: latitude, lng: longitude };
        MAP = MAP.setView(p, 10); //setZoom(10)
        let u = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
        let attribution = "&copy; OpenStreetMap contributors";
        L.tileLayer(u, { attribution }).addTo(MAP);
      }

      getAPIkey();
      askLocation();
      init();
    </script>
  </body>
  <grammarly-desktop-integration
    data-grammarly-shadow-root="true"
  ></grammarly-desktop-integration>
</html>
